service: kira-payment-link-api

frameworkVersion: '4'

useDotenv: true

provider:
  name: aws
  runtime: nodejs20.x
  stage: prod
  region: ${env:AWS_REGION, 'us-east-1'}
  memorySize: 512
  timeout: 30
  architecture: arm64
  
  # Environment variables
  environment:
    NODE_ENV: production
    DATABASES_MONGO_URL: ${env:DATABASES_MONGO_URL}
    JWT_SECRET: ${env:JWT_SECRET}
    JWT_EXPIRES_IN: ${env:JWT_EXPIRES_IN, '1d'}
    S3_BUCKET_NAME: ${env:S3_BUCKET_NAME, ''}
    # Add other environment variables as needed
  
  # API Gateway settings
  apiGateway:
    shouldStartNameWithService: true
    minimumCompressionSize: 1024 # Enable compression for responses over 1KB
    binaryMediaTypes:
      - 'multipart/form-data'
      - 'image/*'
      - 'application/octet-stream'
  
  # CloudWatch Logs
  logs:
    restApi: true
    
  # Tracing
  tracing:
    lambda: true
    apiGateway: true

custom:
  # Serverless Offline configuration for local testing
  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    noPrependStageInUrl: true
    noAuth: true
  
  # Optimization settings
  optimize:
    external:
      - '@nestjs/microservices'
      - '@nestjs/websockets'
      - 'class-transformer/storage'
    excludeFiles: '**/*.spec.ts'

functions:
  main:
    handler: dist/lambda.handler
    events:
      - http:
          method: ANY
          path: /
          cors: true
      - http:
          method: ANY
          path: '{proxy+}'
          cors: true

plugins:
  - serverless-offline
  - serverless-plugin-optimize

# Package settings
package:
  individually: true
  exclude:
    - node_modules/**
    - test/**
    - coverage/**
    - scripts/**
    - k8s/**
    - docker-compose*.yml
    - Dockerfile*
    - '**/*.spec.ts'
    - '**/*.test.ts'
    - '.git/**'
    - '.github/**'
    - '.vscode/**'
    - '*.md'
  include:
    - dist/**
    - node_modules/@nestjs/**
    - node_modules/@codegenie/**
    - node_modules/express/**
    - src/**/*.hbs

# Resources (optional - add DynamoDB tables, S3 buckets, etc.)
resources:
  Resources:
    # CloudWatch Log Group with retention
    MainLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/lambda/${self:service}-prod-main
        RetentionInDays: 30

  # CloudFormation Outputs
  Outputs:
    ApiGatewayRestApiId:
      Description: API Gateway REST API ID
      Value:
        Ref: ApiGatewayRestApi
      Export:
        Name: ${self:service}-prod-ApiGatewayRestApiId
    
    ApiEndpoint:
      Description: API Gateway Endpoint URL
      Value:
        Fn::Sub: https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/prod
    
    MainLambdaFunctionArn:
      Description: Main Lambda Function ARN
      Value:
        Fn::GetAtt:
          - MainLambdaFunction
          - Arn
      Export:
        Name: ${self:service}-prod-MainLambdaFunctionArn
